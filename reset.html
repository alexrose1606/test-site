<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset your password</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 16px; background:#f7f7fb; color:#111; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:16px; background:white; }
    label { display:block; margin:8px 0 4px; }
    input { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:10px; }
    button { margin-top:10px; padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; background:white; cursor:pointer; font-weight:600; }
    .muted { color:#666; }
    .ok { color:#15803d; font-weight:700; }
    .err { color:#b91c1c; font-weight:700; }
  </style>
</head>
<body
  data-supabase-url="https://dtmqecmuynheejxnyrfn.supabase.co"
  data-supabase-anon-key="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0bXFlY211eW5oZWVqeG55cmZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDk3NzksImV4cCI6MjA3NjgyNTc3OX0.E06vwUuYIJqGQlw3ZazaG3W8lfoqaCeEVf_KeUhg0oQ"
>
  <h1>Reset your password</h1>
  <p id="status" class="muted">Loading...</p>

  <div class="card" id="formBox" style="display:none">
    <label>New password</label>
    <input id="newPass" type="password" placeholder="Enter a new password" />
    <button id="saveBtn" type="button">Save new password</button>
  </div>

  <p><a href="./index.html">Back to home</a></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = document.body.dataset.supabaseUrl;
    const SUPABASE_ANON_KEY = document.body.dataset.supabaseAnonKey;

    // PKCE is required
    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      { auth: { flowType: 'pkce' } }
    );

    const statusEl = document.getElementById('status');
    const formBox = document.getElementById('formBox');

    function showForm() {
      statusEl.className = '';
      statusEl.textContent = 'Enter your new password:';
      formBox.style.display = 'block';
    }

    async function resendFromHere() {
      const email = localStorage.getItem('pwreset_email');
      if (!email) return; // nothing we can do
      statusEl.className = '';
      statusEl.textContent = 'Sending a new reset email...';
      // Reuse the current page as the redirect target (the relay will still be used from index.html next time)
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + window.location.pathname
      });
      statusEl.className = error ? 'err' : 'ok';
      statusEl.textContent = error ? error.message : 'Check your inbox for the new reset link.';
    }

    (async () => {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      let exchangeErr = null;

      // 1) Try exchanging the explicit code first (most reliable)
      if (code) {
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        exchangeErr = error || null;
      } else {
        // Fallback to parsing the whole URL (works when params are intact)
        const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
        exchangeErr = error || null;
      }

      if (!exchangeErr) {
        showForm();
        return;
      }

      // 2) If the link is broken but user is already signed in, still allow password change
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        showForm();
        return;
      }

      // 3) If no session and broken/expired link, offer a one-click resend from this browser
      statusEl.className = 'err';
      statusEl.textContent = 'This reset link is invalid or expired.';
      const email = localStorage.getItem('pwreset_email');
      if (email) {
        const btn = document.createElement('button');
        btn.textContent = 'Send me a new reset link';
        btn.onclick = resendFromHere;
        statusEl.insertAdjacentElement('afterend', btn);
      }
    })();

    document.getElementById('saveBtn').addEventListener('click', async () => {
      statusEl.className = '';
      statusEl.textContent = 'Saving...';
      const newPassword = document.getElementById('newPass').value;
      if (!newPassword || newPassword.length < 6) {
        statusEl.className = 'err';
        statusEl.textContent = 'Password must be at least 6 characters.';
        return;
      }
      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) {
        statusEl.className = 'err';
        statusEl.textContent = error.message;
        return;
      }
      statusEl.className = 'ok';
      statusEl.textContent = 'Password updated. You can now log in.';
    });
  </script>
</body>
</html>
