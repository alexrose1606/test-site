<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finishing sign in...</title>
  <style> body { font-family: system-ui, Arial; max-width: 720px; margin: 24px auto; padding: 16px; } .ok{color:#15803d;} .err{color:#b91c1c;} </style>
</head>
<body
  data-supabase-url="https://dtmqecmuynheejxnyrfn.supabase.co"
  data-supabase-anon-key="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0bXFlY211eW5oZWVqeG55cmZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDk3NzksImV4cCI6MjA3NjgyNTc3OX0.E06vwUuYIJqGQlw3ZazaG3W8lfoqaCeEVf_KeUhg0oQ"
>
  <h1>Finishing sign in</h1>
  <p id="msg">Checking the link...</p>
  <p><a href="./app.html">Go to protected page</a></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = document.body.dataset.supabaseUrl;
    const SUPABASE_ANON_KEY = document.body.dataset.supabaseAnonKey;

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      { auth: { flowType: 'pkce' } }
    );

    (async () => {
      const out = await supabase.auth.exchangeCodeForSession(window.location.href);
      const msgEl = document.getElementById('msg');
      if (out.error) {
        msgEl.className = 'err';
        msgEl.textContent = out.error.message;
        return;
      }

      // Optional: upsert profile
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        await supabase.from('profiles').upsert(
          { id: user.id, email: user.email },
          { onConflict: 'id' }
        );
      }

      msgEl.className = 'ok';
      msgEl.textContent = 'Signed in. You can open the protected page.';
    })();
  </script>
</body>
</html>
